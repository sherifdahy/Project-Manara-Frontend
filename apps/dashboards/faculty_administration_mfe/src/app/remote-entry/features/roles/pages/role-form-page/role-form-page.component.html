<ng-container *ngIf="(role$ | async) as role">
  <div class="container-fluid px-0">

    <!-- Page Header with Back Button -->
    <div class="page-header mb-4">
      <div class="d-flex align-items-center gap-3">
        <button class="btn-back" routerLink="/roles">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
        <div>
          <h1 class="page-title mb-1">{{ role.name }}</h1>
          <p class="page-description mb-0">{{ roleMetadata.description }}</p>
        </div>
      </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="row g-3 mb-4">
      <!-- Total Users -->
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="stats-card">
          <div class="stats-header">
            <div class="stats-info">
              <span class="stats-label">Total Users</span>
              <h3 class="stats-number">{{ roleMetadata.usersCount }}</h3>
              <span class="stats-meta">Assigned to role</span>
            </div>
            <div class="stats-icon-wrapper bg-primary-soft">
              <i class="fa-solid fa-users text-primary"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Assigned Permissions -->
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="stats-card">
          <div class="stats-header">
            <div class="stats-info">
              <span class="stats-label">Assigned</span>
              <h3 class="stats-number">{{ selectedPermissions.length }}</h3>
              <span class="stats-meta text-success">Selected permissions</span>
            </div>
            <div class="stats-icon-wrapper bg-success-soft">
              <i class="fa-solid fa-check-circle text-success"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Available Permissions -->
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="stats-card">
          <div class="stats-header">
            <div class="stats-info">
              <span class="stats-label">Available</span>
              <h3 class="stats-number">{{ allPermissions.length }}</h3>
              <span class="stats-meta">Total permissions</span>
            </div>
            <div class="stats-icon-wrapper bg-warning-soft">
              <i class="fa-solid fa-shield-alt text-warning"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Role Status -->
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="stats-card">
          <div class="stats-header">
            <div class="stats-info">
              <span class="stats-label">Role Status</span>
              <h3 class="stats-number">
                <span class="table-status-badge" [ngClass]="{
                  'status-active': !role.isDeleted,
                  'status-inactive': role.isDeleted
                }">
                  {{ role.isDeleted ? 'Disabled' : 'Active' }}
                </span>
              </h3>
              <span class="stats-meta">{{ roleMetadata.defaultPortal }} Portal</span>
            </div>
            <div class="stats-icon-wrapper bg-info-soft">
              <i class="fa-solid fa-door-open text-info"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Permissions Management Section -->
    <div class="permissions-section">
      <div class="section-card">

        <!-- Section Header -->
        <div class="section-header">
          <div>
            <h4 class="section-title">Manage Permissions</h4>
            <p class="section-subtitle">Select permissions to assign to this role</p>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn-select-action" (click)="selectAll()">
              <i class="fa-solid fa-check-double me-2"></i> Select All
            </button>
            <button class="btn-select-action" (click)="deselectAll()">
              <i class="fa-solid fa-times me-2"></i> Deselect All
            </button>
          </div>
        </div>

        <!-- Search and Filter Bar -->
        <div class="filters-wrapper mb-3">
          <!-- Search Bar -->
          <div class="search-bar-container">
            <div class="search-bar">
              <i class="fa-solid fa-search search-icon"></i>
              <input type="text" class="search-input" placeholder="Search permissions..." [(ngModel)]="searchQuery">
            </div>
          </div>
        </div>

        <!-- Permissions Categories -->
        <div class="permissions-container">
          <div *ngFor="let category of categories" class="permission-category">

            <!-- Category Header -->
            <div class="category-header" (click)="category.expanded = !category.expanded">
              <div class="d-flex align-items-center gap-2">
                <div>
                  <h5 class="category-title">{{ category.name }}</h5>
                  <p class="category-subtitle">
                    {{ getSelectedCount(category) }} of {{ category.permissions.length }} selected
                  </p>
                </div>
              </div>
              <button class="btn-category-toggle">
                <i class="fa-solid" [ngClass]="{
                  'fa-chevron-down': !category.expanded,
                  'fa-chevron-up': category.expanded
                }"></i>
              </button>
            </div>

            <!-- Permissions List -->
            <div class="permissions-list" *ngIf="category.expanded">
              <div *ngFor="let permission of getCategoryPermissions(category)" class="permission-item">
                <label class="permission-checkbox">
                  <input type="checkbox" [checked]="isSelected(permission.key)" (change)="toggle(permission.key)">
                  <span class="checkbox-custom"></span>
                  <div class="permission-info">
                    <span class="permission-name">{{ permission.name }}</span>
                    <span class="permission-description">{{ permission.desc }}</span>
                  </div>
                </label>
              </div>

              <!-- Empty state for category -->
              <div *ngIf="getCategoryPermissions(category).length === 0" class="no-permissions">
                <i class="fa-solid fa-search"></i>
                <p>No permissions match your search</p>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn-cancel" routerLink="/roles">
        <i class="fa-solid fa-times me-2"></i> Cancel
      </button>
      <button class="btn-save" (click)="save()" [disabled]="!hasChanges()">
        <i class="fa-solid fa-save me-2"></i> Save Changes
      </button>
    </div>

  </div>
</ng-container>
